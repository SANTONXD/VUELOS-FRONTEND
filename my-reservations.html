<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Mis Reservas</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" type="image/png" href="favicon/reserva.png">
</head>

<body>

<header>
  <h1>Mis Reservas</h1>
</header>

<nav>
  <a href="flights.html">← Volver a vuelos</a>
</nav>

<main>

<ul id="reservationsList"></ul>
<p id="msg"></p>

</main>

<footer>
  <a href="https://github.com/SANTONXD/VUELOS-FRONTEND/tree/main" target="_blank">
    <svg height="24" width="24" viewBox="0 0 16 16" fill="#b44a55">
      <path d="M8 0C3.58 0 0 ..."></path>
    </svg>
  </a>
</footer>

<script>
  const API_BASE = 'https://proyecto-sis.onrender.com';
  const token = localStorage.getItem('token');
  if (!token) location.href = 'login.html';

  const msg = document.getElementById('msg');
  const list = document.getElementById('reservationsList');

  async function loadReservations() {
    msg.textContent = "Cargando...";

    const res = await fetch(API_BASE + "/reservations/my-reservations", {
      headers: { "Authorization": "Bearer " + token }
    });

    const data = await res.json();
    list.innerHTML = "";

    if (!Array.isArray(data) || data.length === 0) {
      list.innerHTML = "<li>No tienes reservas aún.</li>";
      msg.textContent = "";
      return;
    }

    data.forEach(r => {
      const li = document.createElement("li");

      const paid = (r.status === 'paid' || r.status === 'pagado');

      li.innerHTML = `
        <div class="res-info">
          <span class="res-route">${r.origin} → ${r.destination}</span>
          <span class="res-seat">${r.seat_number}</span>
          <span class="res-depart">${new Date(r.departure).toLocaleString()}</span>
          <span class="res-code">Código: ${r.code}</span>
        </div>
        <div class="res-actions">
          ${paid ? '<strong class="paid-label">Pagado</strong>' : `<button data-pay="${r.reservation_id}">Pagar</button>`}
        </div>
      `;

      list.appendChild(li);
    });

    // Manejo de evento para "Pagar" y formulario inline
    list.addEventListener('click', async (e) => {
      const payBtn = e.target.closest('button[data-pay]');
      if (!payBtn) return;

      const reservationId = payBtn.getAttribute('data-pay');
      const li = payBtn.closest('li');

      // Evitar múltiples formularios
      if (li.querySelector('form.pay-form')) return;

      // Formulario simple (simulación de pago)
      li.insertAdjacentHTML('beforeend', `
        <form class="pay-form" data-id="${reservationId}">
          <label>Nombre en tarjeta<input name="card_name" required></label>
          <label>N.º tarjeta<input name="card_number" required maxlength="19"></label>
          <label>Expira<input name="expiry" placeholder="MM/AA" required></label>
          <label>CVV<input name="cvv" required maxlength="4"></label>
          <div>
            <button type="submit">Confirmar pago</button>
            <button type="button" class="cancel-pay">Cancelar</button>
          </div>
        </form>
      `);

      const form = li.querySelector('form.pay-form');

      // Cancelar
      form.querySelector('.cancel-pay').addEventListener('click', () => {
        form.remove();
      });

      // Enviar (simulado)
      form.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        msg.textContent = 'Procesando pago...';

        const fd = new FormData(form);
        const body = {
          card_name: fd.get('card_name'),
          card_number: fd.get('card_number'),
          expiry: fd.get('expiry'),
          cvv: fd.get('cvv')
        };

        try {
          const res = await fetch(`${API_BASE}/reservations/${reservationId}/pay`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify(body)
          });

          const data = await res.json();
          if (!res.ok) {
            msg.textContent = data.error || 'Error procesando el pago';
            return;
          }

          // Mostrar resultado y quitar reserva de la lista
          msg.textContent = data.message || 'Pago realizado';
          // Remover el elemento de la lista
          li.remove();

        } catch (err) {
          msg.textContent = 'Error al pagar: ' + err.message;
        }
      });
    });

    msg.textContent = "";
  }

  loadReservations();
</script>

</body>
</html>

